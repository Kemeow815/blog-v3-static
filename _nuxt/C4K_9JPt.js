import{d as y,U as x,f as u,o as M,az as b,g as r,h as i,i as o,k as f,q as I,n as d,D as E,F as _,m as L,aT as N,l as S,j as $,t as v,X as D,_ as A}from"#entry";const F=globalThis.setInterval,z={class:"widget-card comments-container"},B={key:0,class:"loading"},O={key:1,class:"error"},P={key:2,class:"comments-list"},R=["onClick"],j={class:"comment-meta"},U={class:"author-info"},V=["src","alt"],H={class:"author"},q={class:"date"},G=["innerHTML"],W="https://kemiao-twikoo.050815.xyz/",X="b624bd863eaf16b3eef5efc9ce6086e7",J=y({__name:"LatestComments",setup(K){const s=x("latestComments",()=>({comments:[],loading:!0,error:!1,lastFetchTime:0})),h=u(()=>s.value.comments),p=u(()=>s.value.loading),g=u(()=>s.value.error);function k(n){const a=[{max:60,text:"刚刚"},{max:3600,div:60,unit:"分钟前"},{max:86400,div:3600,unit:"小时前"},{max:604800,div:86400,unit:"天前"}],e=Math.floor((Date.now()-n)/1e3),t=a.find(c=>e<c.max);return t?t.div!==void 0?`${Math.floor(e/t.div)}${t.unit}`:t.text:`${new Intl.DateTimeFormat("zh-CN",{month:"numeric",day:"numeric"}).format(n)}日`}function T(n){return n?Object.entries({"<pre><code>[\\s\\S]*?</code></pre>":"[代码块]","<code>([^<]{4,})</code>":"[代码]","<code>([^<]{1,3})</code>":"$1",'<img(?![^>]*class="tk-owo-emotion")[^>]*>':"[图片]","<a[^>]*?>[\\s\\S]*?</a>":"[链接]",'<(?!img[^>]*class="tk-owo-emotion")[^>]+>':""}).reduce((e,[t,c])=>e.replace(new RegExp(t,"g"),c),n).trim():""}async function m(){const n=Date.now();if(!(n-s.value.lastFetchTime<600*1e3))try{s.value.loading=!0,s.value.error=!1;const a=await $fetch(W,{method:"POST",body:{event:"GET_RECENT_COMMENTS",includeReply:!0,pageSize:10},timeout:5e3});if(!a?.data)throw new Error("No data");s.value.comments=a.data.filter(e=>e.url!=="/").slice(0,5).map(e=>({content:T(e.comment),author:e.nick,date:k(e.created),avatar:e.avatar,isAdmin:e.mailMd5===X,url:e.url,id:e.id})),s.value.lastFetchTime=n}catch{s.value.error=!0}finally{s.value.loading=!1}}let l=null;function w(){m(),l=F(m,600*1e3)}function C(){l&&(clearInterval(l),l=null)}return M(()=>w()),b(()=>C()),(n,a)=>{const e=E;return i(),r(_,null,[a[2]||(a[2]=o("h3",{class:"widget-title"}," 最新评论 ",-1)),o("div",z,[f(D,{name:"fade",mode:"out-in"},{default:I(()=>[d(p)?(i(),r("div",B,[...a[0]||(a[0]=[o("div",{class:"loading-spinner"},null,-1),o("p",null,"加载中...",-1)])])):d(g)?(i(),r("div",O,[f(e,{name:"line-md:alert",class:"error-icon"}),a[1]||(a[1]=o("span",null,"评论加载失败",-1))])):(i(),r("ul",P,[(i(!0),r(_,null,L(d(h),t=>(i(),r("li",{key:t.id,class:"comment-item",onClick:c=>("navigateTo"in n?n.navigateTo:d(N))(`${t.url}#${t.id}`)},[o("div",j,[o("div",U,[o("img",{src:t.avatar,alt:t.author,class:"avatar"},null,8,V),o("span",H,v(t.author),1),t.isAdmin?(i(),S(e,{key:0,name:"ph:seal-check-fill",class:"admin-badge"})):$("",!0)]),o("time",q,v(t.date),1)]),o("p",{class:"comment-content",title:"点击查看完整评论",innerHTML:t.content},null,8,G)],8,R))),128))]))]),_:1})])],64)}}}),Y=Object.assign(A(J,[["__scopeId","data-v-3f4f84b3"]]),{__name:"WidgetLatestComments"});export{Y as default};
