import{d as T,U as C,f as m,o as y,az as x,g as r,h as i,i as o,k as f,q as M,n as c,D as E,F as _,m as I,aT as L,l as N,j as S,t as v,X as $,_ as b}from"#entry";const D={class:"widget-card comments-container"},A={key:0,class:"loading"},F={key:1,class:"error"},z={key:2,class:"comments-list"},B=["onClick"],O={class:"comment-meta"},R={class:"author-info"},j=["src","alt"],U={class:"author"},V={class:"date"},H=["innerHTML"],P="https://kemiao-twikoo.050815.xyz",q="b624bd863eaf16b3eef5efc9ce6086e7",G=T({__name:"LatestComments",setup(W){const s=C("latestComments",()=>({comments:[],loading:!0,error:!1,lastFetchTime:0})),h=m(()=>s.value.comments),p=m(()=>s.value.loading),g=m(()=>s.value.error);function k(n){const a=[{max:60,text:"刚刚"},{max:3600,div:60,unit:"分钟前"},{max:86400,div:3600,unit:"小时前"},{max:604800,div:86400,unit:"天前"}],e=Math.floor((Date.now()-n)/1e3),t=a.find(l=>e<l.max);return t?t.div!==void 0?`${Math.floor(e/t.div)}${t.unit}`:t.text:`${new Intl.DateTimeFormat("zh-CN",{month:"numeric",day:"numeric"}).format(n)}日`}function w(n){return n?Object.entries({"<pre><code>[\\s\\S]*?</code></pre>":"[代码块]","<code>([^<]{4,})</code>":"[代码]","<code>([^<]{1,3})</code>":"$1",'<img(?![^>]*class="tk-owo-emotion")[^>]*>':"[图片]","<a[^>]*?>[\\s\\S]*?</a>":"[链接]",'<(?!img[^>]*class="tk-owo-emotion")[^>]+>':""}).reduce((e,[t,l])=>e.replace(new RegExp(t,"g"),l),n).trim():""}async function u(){const n=Date.now();if(!(n-s.value.lastFetchTime<600*1e3))try{s.value.loading=!0,s.value.error=!1;const a=await $fetch(P,{method:"POST",body:{event:"GET_RECENT_COMMENTS",includeReply:!0,pageSize:10},timeout:5e3});if(!a?.data)throw new Error("No data");s.value.comments=a.data.filter(e=>e.url!=="/").slice(0,5).map(e=>({content:w(e.comment),author:e.nick,date:k(e.created),avatar:e.avatar,isAdmin:e.mailMd5===q,url:e.url,id:e.id})),s.value.lastFetchTime=n}catch{s.value.error=!0}finally{s.value.loading=!1}}let d;return y(()=>{u(),d=window.setInterval(u,600*1e3)}),x(()=>{d&&clearInterval(d)}),(n,a)=>{const e=E;return i(),r(_,null,[a[2]||(a[2]=o("h3",{class:"widget-title"}," 最新评论 ",-1)),o("div",D,[f($,{name:"fade",mode:"out-in"},{default:M(()=>[c(p)?(i(),r("div",A,[...a[0]||(a[0]=[o("div",{class:"loading-spinner"},null,-1),o("p",null,"加载中...",-1)])])):c(g)?(i(),r("div",F,[f(e,{name:"line-md:alert",class:"error-icon"}),a[1]||(a[1]=o("span",null,"评论加载失败",-1))])):(i(),r("ul",z,[(i(!0),r(_,null,I(c(h),t=>(i(),r("li",{key:t.id,class:"comment-item",onClick:l=>("navigateTo"in n?n.navigateTo:c(L))(`${t.url}#${t.id}`)},[o("div",O,[o("div",R,[o("img",{src:t.avatar,alt:t.author,class:"avatar"},null,8,j),o("span",U,v(t.author),1),t.isAdmin?(i(),N(e,{key:0,name:"ph:seal-check-fill",class:"admin-badge"})):S("",!0)]),o("time",V,v(t.date),1)]),o("p",{class:"comment-content",title:"点击查看完整评论",innerHTML:t.content},null,8,H)],8,B))),128))]))]),_:1})])],64)}}}),J=Object.assign(b(G,[["__scopeId","data-v-efffddf7"]]),{__name:"WidgetLatestComments"});export{J as default};
