import{d as T,U as C,f as d,o as y,aA as M,l as p,h as r,q as u,i as o,k as _,X as b,g as l,n as c,D as E,F as I,m as L,Z as N,j as S,t as v,_ as $}from"#entry";import{_ as A}from"./993y4J_I.js";const D={class:"comment-wrap"},F={key:0,class:"state-box"},B={key:1,class:"state-box"},O={key:2,class:"comment-list"},R=["onClick"],j={class:"meta"},z={class:"left"},U=["src","alt"],V={class:"nick"},H={class:"date"},P=["innerHTML"],W="https://kemiao-twikoo.050815.xyz",Z="b624bd863eaf16b3eef5efc9ce6086e7",q=T({__name:"LatestComments",setup(G){const s=C("latestComments",()=>({comments:[],loading:!0,error:!1,lastFetchTime:0})),h=d(()=>s.value.comments),g=d(()=>s.value.loading),k=d(()=>s.value.error);function x(n){const a=[{max:60,text:"刚刚"},{max:3600,div:60,unit:"分钟前"},{max:86400,div:3600,unit:"小时前"},{max:604800,div:86400,unit:"天前"}],e=Math.floor((Date.now()-n)/1e3),i=a.find(t=>e<t.max);return i?i.div!==void 0?`${Math.floor(e/i.div)}${i.unit}`:i.text:`${new Intl.DateTimeFormat("zh-CN",{month:"numeric",day:"numeric"}).format(n)}日`}function w(n){return n?Object.entries({"<pre><code>[\\s\\S]*?</code></pre>":"[代码块]","<code>([^<]{4,})</code>":"[代码]","<code>([^<]{1,3})</code>":"$1",'<img(?![^>]*class="tk-owo-emotion")[^>]*>':"[图片]","<a[^>]*?>[\\s\\S]*?</a>":"[链接]",'<(?!img[^>]*class="tk-owo-emotion")[^>]+>':""}).reduce((e,[i,t])=>e.replace(new RegExp(i,"g"),t),n).trim():""}async function f(){const n=Date.now();if(!(n-s.value.lastFetchTime<600*1e3))try{s.value.loading=!0,s.value.error=!1;const a=await $fetch(W,{method:"POST",body:{event:"GET_RECENT_COMMENTS",includeReply:!0,pageSize:10},timeout:5e3});if(!a?.data)throw new Error("No data");s.value.comments=a.data.filter(e=>e.url!=="/").slice(0,5).map(e=>({content:w(e.comment),author:e.nick,date:x(e.created),avatar:e.avatar,isAdmin:e.mailMd5===Z,url:e.url,id:e.id})),s.value.lastFetchTime=n}catch{s.value.error=!0}finally{s.value.loading=!1}}let m;return y(()=>{f(),m=window.setInterval(f,600*1e3)}),M(()=>{m&&clearInterval(m)}),(n,a)=>{const e=E,i=A;return r(),p(i,null,{title:u(()=>[a[0]||(a[0]=o("span",{class:"title"},"最新评论",-1)),_(e,{name:"ph:chat-circle-text-bold"})]),default:u(()=>[o("div",D,[_(b,{name:"fade",mode:"out-in"},{default:u(()=>[c(g)?(r(),l("div",F,[...a[1]||(a[1]=[o("div",{class:"spinner"},null,-1),o("p",null,"加载中…",-1)])])):c(k)?(r(),l("div",B,[_(e,{name:"line-md:alert",class:"error-icon"}),a[2]||(a[2]=o("span",null,"评论加载失败",-1))])):(r(),l("ul",O,[(r(!0),l(I,null,L(c(h),t=>(r(),l("li",{key:t.id,class:"comment-item",onClick:X=>("navigateTo"in n?n.navigateTo:c(N))(`${t.url}#${t.id}`)},[o("div",j,[o("div",z,[o("img",{src:t.avatar,alt:t.author,class:"avatar"},null,8,U),o("span",V,v(t.author),1),t.isAdmin?(r(),p(e,{key:0,name:"ph:seal-check-fill",class:"badge"})):S("",!0)]),o("time",H,v(t.date),1)]),o("p",{class:"content",innerHTML:t.content},null,8,P)],8,R))),128))]))]),_:1})])]),_:1})}}}),Q=Object.assign($(q,[["__scopeId","data-v-5f38a159"]]),{__name:"WidgetLatestComments"});export{Q as default};
